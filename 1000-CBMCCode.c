//
// Created by nsas2020 on 24-3-19.
//
//
// Created by nsas2020 on 23-11-8.
// /usr/local/clang-4.0/bin/clang -emit-llvm -g -c 0-datarace.cpp -o datarace1.bc
//0.005769
//  clang -emit-llvm -S -o 0-datarace.ll 0-datarace.cpp
//  time nidhugg -arm 0-datarace.ll
//  cbmc --arch arm64 --mm pso  0-datarace.c
#include <stdio.h>
#include <pthread.h>
#include <assert.h>

void additional_logic() {
    int temp;
    // 这里增加大量的简单重复代码来扩充行数
    temp = 1;
    temp = 2;
    temp = 3;
    temp = 4;
    temp = 5;
    temp = 6;
    temp = 7;
    temp = 8;
    temp = 9;
    temp = 10;
    temp = 11;
    temp = 12;
    temp = 13;
    temp = 14;
    temp = 15;
    temp = 16;
    temp = 17;
    temp = 18;
    temp = 19;
    temp = 20;
    temp = 21;
    temp = 22;
    temp = 23;
    temp = 24;
    temp = 25;
    temp = 26;
    temp = 27;
    temp = 28;
    temp = 29;
    temp = 30;
    temp = 31;
    temp = 32;
    temp = 33;
    temp = 34;
    temp = 35;
    temp = 36;
    temp = 37;
    temp = 38;
    temp = 39;
    temp = 40;
    temp = 41;
    temp = 42;
    temp = 43;
    temp = 44;
    temp = 45;
    temp = 46;
    temp = 47;
    temp = 48;
    temp = 49;
    temp = 50;
    temp = 51;
    temp = 52;
    temp = 53;
    temp = 54;
    temp = 55;
    temp = 56;
    temp = 57;
    temp = 58;
    temp = 59;
    temp = 60;
    temp = 61;
    temp = 62;
    temp = 63;
    temp = 64;
    temp = 65;
    temp = 66;
    temp = 67;
    temp = 68;
    temp = 69;
    temp = 70;
    temp = 71;
    temp = 72;
    temp = 73;
    temp = 74;
    temp = 75;
    temp = 76;
    temp = 77;
    temp = 78;
    temp = 79;
    temp = 80;
    temp = 81;
    temp = 82;
    temp = 83;
    temp = 84;
    temp = 85;
    temp = 86;
    temp = 87;
    temp = 88;
    temp = 89;
    temp = 90;
    temp = 91;
    temp = 92;
    temp = 93;
    temp = 94;
    temp = 95;
    temp = 96;
    temp = 97;
    temp = 98;
    temp = 99;
    temp = 100;
    temp = 101;
    temp = 102;
    temp = 103;
    temp = 104;
    temp = 105;
    temp = 106;
    temp = 107;
    temp = 108;
    temp = 109;
    temp = 110;
    temp = 111;
    temp = 112;
    temp = 113;
    temp = 114;
    temp = 115;
    temp = 116;
    temp = 117;
    temp = 118;
    temp = 119;
    temp = 120;
    temp = 121;
    temp = 122;
    temp = 123;
    temp = 124;
    temp = 125;
    temp = 126;
    temp = 127;
    temp = 128;
    temp = 129;
    temp = 130;
    temp = 131;
    temp = 132;
    temp = 133;
    temp = 134;
    temp = 135;
    temp = 136;
    temp = 137;
    temp = 138;
    temp = 139;
    temp = 140;
    temp = 141;
    temp = 142;
    temp = 143;
    temp = 144;
    temp = 145;
    temp = 146;
    temp = 147;
    temp = 148;
    temp = 149;
    temp = 150;
    temp = 151;
    temp = 152;
    temp = 153;
    temp = 154;
    temp = 155;
    temp = 156;
    temp = 157;
    temp = 158;
    temp = 159;
    temp = 160;
    temp = 161;
    temp = 162;
    temp = 163;
    temp = 164;
    temp = 165;
    temp = 166;
    temp = 167;
    temp = 168;
    temp = 169;
    temp = 170;
    temp = 171;
    temp = 172;
    temp = 173;
    temp = 174;
    temp = 175;
    temp = 176;
    temp = 177;
    temp = 178;
    temp = 179;
    temp = 180;
    temp = 181;
    temp = 182;
    temp = 183;
    temp = 184;
    temp = 185;
    temp = 186;
    temp = 187;
    temp = 188;
    temp = 189;
    temp = 190;
    temp = 191;
    temp = 192;
    temp = 193;
    temp = 194;
    temp = 195;
    temp = 196;
    temp = 197;
    temp = 198;
    temp = 199;
    temp = 200;
    temp = 201;
    temp = 202;
    temp = 203;
    temp = 204;
    temp = 205;
    temp = 206;
    temp = 207;
    temp = 208;
    temp = 209;
    temp = 210;
    temp = 211;
    temp = 212;
    temp = 213;
    temp = 214;
    temp = 215;
    temp = 216;
    temp = 217;
    temp = 218;
    temp = 219;
    temp = 220;
    temp = 221;
    temp = 222;
    temp = 223;
    temp = 224;
    temp = 225;
    temp = 226;
    temp = 227;
    temp = 228;
    temp = 229;
    temp = 230;
    temp = 231;
    temp = 232;
    temp = 233;
    temp = 234;
    temp = 235;
    temp = 236;
    temp = 237;
    temp = 238;
    temp = 239;
    temp = 240;
    temp = 241;
    temp = 242;
    temp = 243;
    temp = 244;
    temp = 245;
    temp = 246;
    temp = 247;
    temp = 248;
    temp = 249;
    temp = 250;
    temp = 251;
    temp = 252;
    temp = 253;
    temp = 254;
    temp = 255;
    temp = 256;
    temp = 257;
    temp = 258;
    temp = 259;
    temp = 260;
    temp = 261;
    temp = 262;
    temp = 263;
    temp = 264;
    temp = 265;
    temp = 266;
    temp = 267;
    temp = 268;
    temp = 269;
    temp = 270;
    temp = 271;
    temp = 272;
    temp = 273;
    temp = 274;
    temp = 275;
    temp = 276;
    temp = 277;
    temp = 278;
    temp = 279;
    temp = 280;
    temp = 281;
    temp = 282;
    temp = 283;
    temp = 284;
    temp = 285;
    temp = 286;
    temp = 287;
    temp = 288;
    temp = 289;
    temp = 290;
    temp = 291;
    temp = 292;
    temp = 293;
    temp = 294;
    temp = 295;
    temp = 296;
    temp = 297;
    temp = 298;
    temp = 299;
    temp = 300;
    temp = 301;
    temp = 302;
    temp = 303;
    temp = 304;
    temp = 305;
    temp = 306;
    temp = 307;
    temp = 308;
    temp = 309;
    temp = 310;
    temp = 311;
    temp = 312;
    temp = 313;
    temp = 314;
    temp = 315;
    temp = 316;
    temp = 317;
    temp = 318;
    temp = 319;
    temp = 320;
    temp = 321;
    temp = 322;
    temp = 323;
    temp = 324;
    temp = 325;
    temp = 326;
    temp = 327;
    temp = 328;
    temp = 329;
    temp = 330;
    temp = 331;
    temp = 332;
    temp = 333;
    temp = 334;
    temp = 335;
    temp = 336;
    temp = 337;
    temp = 338;
    temp = 339;
    temp = 340;
    temp = 341;
    temp = 342;
    temp = 343;
    temp = 344;
    temp = 345;
    temp = 346;
    temp = 347;
    temp = 348;
    temp = 349;
    temp = 350;
    temp = 351;
    temp = 352;
    temp = 353;
    temp = 354;
    temp = 355;
    temp = 356;
    temp = 357;
    temp = 358;
    temp = 359;
    temp = 360;
    temp = 361;
    temp = 362;
    temp = 363;
    temp = 364;
    temp = 365;
    temp = 366;
    temp = 367;
    temp = 368;
    temp = 369;
    temp = 370;
    temp = 371;
    temp = 372;
    temp = 373;
    temp = 374;
    temp = 375;
    temp = 376;
    temp = 377;
    temp = 378;
    temp = 379;
    temp = 380;
    temp = 381;
    temp = 382;
    temp = 383;
    temp = 384;
    temp = 385;
    temp = 386;
    temp = 387;
    temp = 388;
    temp = 389;
    temp = 390;
    temp = 391;
    temp = 392;
    temp = 393;
    temp = 394;
    temp = 395;
    temp = 396;
    temp = 397;
    temp = 398;
    temp = 399;
    temp = 400;
    temp = 401;
    temp = 402;
    temp = 403;
    temp = 404;
    temp = 405;
    temp = 406;
    temp = 407;
    temp = 408;
    temp = 409;
    temp = 410;
    temp = 411;
    temp = 412;
    temp = 413;
    temp = 414;
    temp = 415;
    temp = 416;
    temp = 417;
    temp = 418;
    temp = 419;
    temp = 420;
    temp = 421;
    temp = 422;
    temp = 423;
    temp = 424;
    temp = 425;
    temp = 426;
    temp = 427;
    temp = 428;
    temp = 429;
    temp = 430;
    temp = 431;
    temp = 432;
    temp = 433;
    temp = 434;
    temp = 435;
    temp = 436;
    temp = 437;
    temp = 438;
    temp = 439;
    temp = 440;
    temp = 441;
    temp = 442;
    temp = 443;
    temp = 444;
    temp = 445;
    temp = 446;
    temp = 447;
    temp = 448;
    temp = 449;
    temp = 450;
    temp = 451;
    temp = 452;
    temp = 453;
    temp = 454;
    temp = 455;
    temp = 456;
    temp = 457;
    temp = 458;
    temp = 459;
    temp = 460;
    temp = 461;
    temp = 462;
    temp = 463;
    temp = 464;
    temp = 465;
    temp = 466;
    temp = 467;
    temp = 468;
    temp = 469;
    temp = 470;
    temp = 471;
    temp = 472;
    temp = 473;
    temp = 474;
    temp = 475;
    temp = 476;
    temp = 477;
    temp = 478;
    temp = 479;
    temp = 480;
    temp = 481;
    temp = 482;
    temp = 483;
    temp = 484;
    temp = 485;
    temp = 486;
    temp = 487;
    temp = 488;
    temp = 489;
    temp = 490;
    temp = 491;
    temp = 492;
    temp = 493;
    temp = 494;
    temp = 495;
    temp = 496;
    temp = 497;
    temp = 498;
    temp = 499;
    temp = 500;
    temp = 501;
    temp = 502;
    temp = 503;
    temp = 504;
    temp = 505;
    temp = 506;
    temp = 507;
    temp = 508;
    temp = 509;
    temp = 510;
    temp = 511;
    temp = 512;
    temp = 513;
    temp = 514;
    temp = 515;
    temp = 516;
    temp = 517;
    temp = 518;
    temp = 519;
    temp = 520;
    temp = 521;
    temp = 522;
    temp = 523;
    temp = 524;
    temp = 525;
    temp = 526;
    temp = 527;
    temp = 528;
    temp = 529;
    temp = 530;
    temp = 531;
    temp = 532;
    temp = 533;
    temp = 534;
    temp = 535;
    temp = 536;
    temp = 537;
    temp = 538;
    temp = 539;
    temp = 540;
    temp = 541;
    temp = 542;
    temp = 543;
    temp = 544;
    temp = 545;
    temp = 546;
    temp = 547;
    temp = 548;
    temp = 549;
    temp = 550;
    temp = 551;
    temp = 552;
    temp = 553;
    temp = 554;
    temp = 555;
    temp = 556;
    temp = 557;
    temp = 558;
    temp = 559;
    temp = 560;
    temp = 561;
    temp = 562;
    temp = 563;
    temp = 564;
    temp = 565;
    temp = 566;
    temp = 567;
    temp = 568;
    temp = 569;
    temp = 570;
    temp = 571;
    temp = 572;
    temp = 573;
    temp = 574;
    temp = 575;
    temp = 576;
    temp = 577;
    temp = 578;
    temp = 579;
    temp = 580;
    temp = 581;
    temp = 582;
    temp = 583;
    temp = 584;
    temp = 585;
    temp = 586;
    temp = 587;
    temp = 588;
    temp = 589;
    temp = 590;
    temp = 591;
    temp = 592;
    temp = 593;
    temp = 594;
    temp = 595;
    temp = 596;
    temp = 597;
    temp = 598;
    temp = 599;
    temp = 600;
    temp = 601;
    temp = 602;
    temp = 603;
    temp = 604;
    temp = 605;
    temp = 606;
    temp = 607;
    temp = 608;
    temp = 609;
    temp = 610;
    temp = 611;
    temp = 612;
    temp = 613;
    temp = 614;
    temp = 615;
    temp = 616;
    temp = 617;
    temp = 618;
    temp = 619;
    temp = 620;
    temp = 621;
    temp = 622;
    temp = 623;
    temp = 624;
    temp = 625;
    temp = 626;
    temp = 627;
    temp = 628;
    temp = 629;
    temp = 630;
    temp = 631;
    temp = 632;
    temp = 633;
    temp = 634;
    temp = 635;
    temp = 636;
    temp = 637;
    temp = 638;
    temp = 639;
    temp = 640;
    temp = 641;
    temp = 642;
    temp = 643;
    temp = 644;
    temp = 645;
    temp = 646;
    temp = 647;
    temp = 648;
    temp = 649;
    temp = 650;
    temp = 651;
    temp = 652;
    temp = 653;
    temp = 654;
    temp = 655;
    temp = 656;
    temp = 657;
    temp = 658;
    temp = 659;
    temp = 660;
    temp = 661;
    temp = 662;
    temp = 663;
    temp = 664;
    temp = 665;
    temp = 666;
    temp = 667;
    temp = 668;
    temp = 669;
    temp = 670;
    temp = 671;
    temp = 672;
    temp = 673;
    temp = 674;
    temp = 675;
    temp = 676;
    temp = 677;
    temp = 678;
    temp = 679;
    temp = 680;
    temp = 681;
    temp = 682;
    temp = 683;
    temp = 684;
    temp = 685;
    temp = 686;
    temp = 687;
    temp = 688;
    temp = 689;
    temp = 690;
    temp = 691;
    temp = 692;
    temp = 693;
    temp = 694;
    temp = 695;
    temp = 696;
    temp = 697;
    temp = 698;
    temp = 699;
    temp = 700;
    temp = 701;
    temp = 702;
    temp = 703;
    temp = 704;
    temp = 705;
    temp = 706;
    temp = 707;
    temp = 708;
    temp = 709;
    temp = 710;
    temp = 711;
    temp = 712;
    temp = 713;
    temp = 714;
    temp = 715;
    temp = 716;
    temp = 717;
    temp = 718;
    temp = 719;
    temp = 720;
    temp = 721;
    temp = 722;
    temp = 723;
    temp = 724;
    temp = 725;
    temp = 726;
    temp = 727;
    temp = 728;
    temp = 729;
    temp = 730;
    temp = 731;
    temp = 732;
    temp = 733;
    temp = 734;
    temp = 735;
    temp = 736;
    temp = 737;
    temp = 738;
    temp = 739;
    temp = 740;
    temp = 741;
    temp = 742;
    temp = 743;
    temp = 744;
    temp = 745;
    temp = 746;
    temp = 747;
    temp = 748;
    temp = 749;
    temp = 750;
    temp = 751;
    temp = 752;
    temp = 753;
    temp = 754;
    temp = 755;
    temp = 756;
    temp = 757;
    temp = 758;
    temp = 759;
    temp = 760;
    temp = 761;
    temp = 762;
    temp = 763;
    temp = 764;
    temp = 765;
    temp = 766;
    temp = 767;
    temp = 768;
    temp = 769;
    temp = 770;
    temp = 771;
    temp = 772;
    temp = 773;
    temp = 774;
    temp = 775;
    temp = 776;
    temp = 777;
    temp = 778;
    temp = 779;
    temp = 780;
    temp = 781;
    temp = 782;
    temp = 783;
    temp = 784;
    temp = 785;
    temp = 786;
    temp = 787;
    temp = 788;
    temp = 789;
    temp = 790;
    temp = 791;
    temp = 792;
    temp = 793;
    temp = 794;
    temp = 795;
    temp = 796;
    temp = 797;
    temp = 798;
    temp = 799;
    temp = 800;
    temp = 801;
    temp = 802;
    temp = 803;
    temp = 804;
    temp = 805;
    temp = 806;
    temp = 807;
    temp = 808;
    temp = 809;
    temp = 810;
    temp = 811;
    temp = 812;
    temp = 813;
    temp = 814;
    temp = 815;
    temp = 816;
    temp = 817;
    temp = 818;
    temp = 819;
    temp = 820;
    temp = 821;
    temp = 822;
    temp = 823;
    temp = 824;
    temp = 825;
    temp = 826;
    temp = 827;
    temp = 828;
    temp = 829;
    temp = 830;
    temp = 831;
    temp = 832;
    temp = 833;
    temp = 834;
    temp = 835;
    temp = 836;
    temp = 837;
    temp = 838;
    temp = 839;
    temp = 840;
    temp = 841;
    temp = 842;
    temp = 843;
    temp = 844;
    temp = 845;
    temp = 846;
    temp = 847;
    temp = 848;
    temp = 849;
    temp = 850;
    temp = 851;
    temp = 852;
    temp = 853;
    temp = 854;
    temp = 855;
    temp = 856;
    temp = 857;
    temp = 858;
    temp = 859;
    temp = 860;
    temp = 861;
    temp = 862;
    temp = 863;
    temp = 864;
    temp = 865;
    temp = 866;
    temp = 867;
    temp = 868;
    temp = 869;
    temp = 870;
    temp = 871;
    temp = 872;
    temp = 873;
    temp = 874;
    temp = 875;
    temp = 876;
    temp = 877;
    temp = 878;
    temp = 879;
    temp = 880;
    temp = 881;
    temp = 882;
    temp = 883;
    temp = 884;
    temp = 885;
    temp = 886;
    temp = 887;
    temp = 888;
    temp = 889;
    temp = 890;
    temp = 891;
    temp = 892;
    temp = 893;
    temp = 894;
    temp = 895;
    temp = 896;
    temp = 897;
    temp = 898;
    temp = 899;
    temp = 900;
    temp = 901;
    temp = 902;
    temp = 903;
    temp = 904;
    temp = 905;
    temp = 906;
    temp = 907;
    temp = 908;
    temp = 909;
    temp = 910;
    temp = 911;
    temp = 912;
    temp = 913;
    temp = 914;
    temp = 915;
    temp = 916;
    temp = 917;
    temp = 918;
    temp = 919;
    temp = 920;
    temp = 921;
    temp = 922;
    temp = 923;
    temp = 924;
    temp = 925;
    temp = 926;
    temp = 927;
    temp = 928;
    temp = 929;
    temp = 930;
    temp = 931;
    temp = 932;
    temp = 933;
    temp = 934;
    temp = 935;
    temp = 936;
    temp = 937;
    temp = 938;
    temp = 939;
    temp = 940;
    temp = 941;
    temp = 942;
    temp = 943;
    temp = 944;
    temp = 945;
    temp = 946;
    temp = 947;
    temp = 948;
    temp = 949;
    temp = 950;
    temp = 951;
    temp = 952;
    temp = 953;
    temp = 954;
    temp = 955;
    temp = 956;
    temp = 957;
    temp = 958;
    temp = 959;
    temp = 960;
    temp = 961;
    temp = 962;
    temp = 963;
    temp = 964;
    temp = 965;
    temp = 966;
    temp = 967;
    temp = 968;
    temp = 969;
    temp = 970;
    temp = 971;
    temp = 972;
    temp = 973;
    temp = 974;
    temp = 975;
    temp = 976;
    temp = 977;
    temp = 978;
    temp = 979;
    temp = 980;
    temp = 981;
    temp = 982;
    temp = 983;
    temp = 984;
    temp = 985;
    temp = 986;
    temp = 987;
    temp = 988;
    temp = 989;
    temp = 990;
    temp = 991;
    temp = 992;
    temp = 993;
    temp = 994;
    temp = 995;
    temp = 996;
    temp = 997;
    temp = 998;
    temp = 999;
    temp = 1000;
}

int data = 0; // 全局变量，表示要共享的数据
int flag = 0; // 全局变量，作为一个信号，指示数据是否已写入
char str[50]; // 声明一个足够大的字符数组来存储生成的字符串



// 线程1的函数
void *writer_thread(void *args) {
    for (int i=0; i<= 10; i++){
        additional_logic();
    }
    additional_logic();
    additional_logic();
    additional_logic();
    additional_logic();
    additional_logic();
    for (int i=0; i<= 10; i++){
        additional_logic();
    }
    additional_logic();
    additional_logic();
    additional_logic();
    additional_logic();
    additional_logic();






    data = 42; // 写入数据
    flag = 1;  // 设置flag值为1，表示数据已经写入
    return NULL;
}

// 线程2的函数
void *reader_thread(void *args) {
    // 这个循环检查flag是否为1，但如果指令重排发生，
    // flag可能先被设置为1，而data还未被写入正确的值
    if (flag == 1) {
        assert(data == 42);
    }
    return NULL;
}

int main() {
    pthread_t writer, reader;
    int num = 0;

    // 创建两个线程
    pthread_create(&writer, NULL, writer_thread, NULL);
    pthread_create(&reader, NULL, reader_thread, NULL);

    // 等待线程结束
    pthread_join(writer, NULL);
    pthread_join(reader, NULL);
    return 0;
}